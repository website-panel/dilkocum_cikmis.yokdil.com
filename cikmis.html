<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elektronik Sınav Uygulaması</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .question-text mark { background-color: #fff59d; border-radius: 3px; padding: 0 2px; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-container">
        <!-- SINAV ARAYÜZÜ -->
        <div id="sinav-arayuzu" class="flex flex-col min-h-screen">
            <header class="bg-slate-800 text-white shadow-md sticky top-0 z-40">
                <div class="container mx-auto px-4 py-3 text-center">
                    <h1 class="text-xl font-bold">Elektronik Sınav Uygulaması</h1>
                </div>
            </header>
            <div class="bg-white border-b border-slate-200 sticky top-[61px] z-40">
                <div class="container mx-auto px-4 py-2 flex flex-wrap justify-between items-center gap-4">
                     <div class="user-info flex items-center gap-3">
                        <svg class="w-10 h-10 text-slate-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"/></svg>
                        <div class="user-details"><strong class="kullanici-ad-soyad font-semibold text-slate-700">Yükleniyor...</strong></div>
                    </div>
                    <div class="time-info flex items-center gap-2">
                        <span class="time-label text-slate-500">Kalan Süre:</span>
                        <span id="main-exam-timer" class="time-box font-mono text-2xl font-bold text-red-600">--:--:--</span>
                    </div>
                    <div class="status-controls flex gap-2">
                         <button id="sinav-pdf-indir-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2 transform hover:scale-105">📄 Soruları İndir</button>
                         <button id="sinav-sonlandir-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2 transform hover:scale-105">🛑 Sınavı Sonlandır</button>
                         <button id="sonuclara-don-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 items-center gap-2 hidden transform hover:scale-105">📊 Sonuçlara Dön</button>
                    </div>
                </div>
            </div>

            <main class="container mx-auto px-4 py-8 flex-grow max-w-7xl">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-2xl shadow-lg flex flex-col">
                        <div id="soru-icerik" class="flex-grow">
                            <!-- Soru içeriği buraya dinamik olarak gelecek -->
                        </div>
                        <div class="flex justify-between mt-8 pt-6 border-t border-slate-200">
                            <button id="prev-btn" class="nav-button bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed no-select transform hover:scale-105 disabled:scale-100">← Önceki</button>
                            <button id="next-btn" class="nav-button bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed no-select transform hover:scale-105 disabled:scale-100">Sonraki →</button>
                        </div>
                    </div>

                    <aside class="bg-white p-6 rounded-2xl shadow-lg lg:sticky lg:top-40">
                        <h3 class="text-xl font-bold text-center mb-4 pb-2 border-b-2 border-slate-200">Optik Form</h3>
                        <div id="optik-form-icerik" class="space-y-2 max-h-[calc(100vh-250px)] overflow-y-auto custom-scrollbar pr-2">
                            <!-- Optik form içeriği buraya dinamik olarak gelecek -->
                        </div>
                    </aside>
                </div>
            </main>
        </div>

        <!-- SONUÇ ARAYÜZÜ -->
        <div id="sonuc-arayuzu" class="hidden">
             <header class="bg-slate-800 text-white shadow-md">
                <div class="container mx-auto px-4 py-3 text-center">
                    <h1 class="text-xl font-bold">Sınav Sonuç Raporu: <span id="sonuc-kullanici-ad-soyad"></span></h1>
                </div>
            </header>
             <div class="container mx-auto px-4 py-8 max-w-4xl">
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-6 border-l-8 border-sky-500">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-8 sm:gap-12">
                        <div class="text-center">
                            <p class="text-lg text-slate-500">Net Puanınız</p>
                            <p id="net-sayisi-buyuk" class="text-7xl font-bold text-slate-800">0.00</p>
                        </div>
                        <div class="w-full flex-1 max-w-xs space-y-3">
                            <div class="flex justify-between items-baseline text-lg">
                                <span class="font-semibold text-green-600">DOĞRU</span>
                                <span id="dogru-sayisi" class="text-2xl font-bold text-green-600">0</span>
                            </div>
                             <div class="flex justify-between items-baseline text-lg">
                                <span class="font-semibold text-red-600">YANLIŞ</span>
                                <span id="yanlis-sayisi" class="text-2xl font-bold text-red-600">0</span>
                            </div>
                             <div class="flex justify-between items-baseline text-lg">
                                <span class="font-semibold text-slate-500">BOŞ</span>
                                <span id="bos-sayisi" class="text-2xl font-bold text-slate-500">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="yeni-sinav-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 transform hover:scale-105">🚀 Yeni Sınava Başla</button>
                        <button id="sorulari-incele-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 transform hover:scale-105">🔍 Soruları İncele</button>
                        <button id="sonuc-pdf-indir-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 transform hover:scale-105">📄 Kitapçığı İndir</button>
                        <button id="gecmis-sayfasina-git-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center gap-2 transform hover:scale-105">📜 Tüm Geçmişim</button>
                    </div>
                 </div>
                 <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-center mb-4 pb-2 border-b-2 border-slate-200">Cevap Anahtarı ve Detaylar</h3>
                    <div id="optik-form-sonuc" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                        <!-- Sonuç optik formu buraya gelecek -->
                    </div>
                 </div>
             </div>
        </div>

        <!-- MODAL PENCERELER -->
        <div id="onay-popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 text-center transform transition-all scale-95 opacity-0">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Emin misiniz?</h2>
                <p id="onay-mesaji" class="text-slate-600 mb-6"></p>
                <div class="flex gap-4">
                    <button id="onay-iptal-btn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 rounded-lg transition">İptal</button>
                    <button id="onay-devam-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition">Evet, Onayla</button>
                </div>
            </div>
        </div>

        <div id="bilgi-popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 text-center transform transition-all scale-95 opacity-0">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Bilgi</h2>
                <p id="bilgi-mesaji" class="text-slate-600 mb-6"></p>
                <button id="bilgi-kapat-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-lg transition">Tamam</button>
            </div>
        </div>

        <div id="sayac-popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 text-center transform transition-all scale-95 opacity-0">
                <h2 class="text-2xl font-bold mb-2 text-slate-800">Sonuçlar Hazırlanıyor...</h2>
                <p class="text-slate-600 mb-4">Lütfen bekleyin, sonuçlarınız saniyeler içinde görüntülenecek.</p>
                <div id="gerisayim-sayaci" class="text-7xl font-bold text-sky-500">10</div>
            </div>
        </div>

        <div id="soru-detay-popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh] transform transition-all scale-95 opacity-0">
                <div class="p-6 border-b border-slate-200">
                    <h3 id="soru-detay-baslik" class="text-xl font-bold text-slate-800"></h3>
                </div>
                <div class="p-6 flex-grow overflow-y-auto custom-scrollbar">
                    <div id="soru-detay-metin" class="bg-slate-100 p-4 rounded-lg mb-6 text-lg"></div>
                    <ul id="soru-detay-secenekler" class="space-y-3"></ul>
                </div>
                <div class="p-4 bg-slate-50 border-t border-slate-200 text-right rounded-b-2xl">
                    <button id="soru-detay-kapat-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg transition">Kapat</button>
                </div>
             </div>
        </div>

    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAvaEaHtTwcuCDBIggJGd4w_nzJQM5UlmY", authDomain: "teacher-adminpanel.firebaseapp.com", projectId: "teacher-adminpanel", storageBucket: "teacher-adminpanel.appspot.com", messagingSenderId: "901735644134", appId: "1:901735644134:web:a6aa575a0754de1333f427", measurementId: "G-68BWZJYCK9" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
 
        // --- SORU HAVUZU ---
const SORU_HAVUZU = [ 
  {
        "metin": "Drinking unpasteurised milk puts you at 100 times greater risk of contracting bacteria like E. coli or listeria, ---- can make you sick with diarrhoea, vomiting, and even kidney failure.",
        "secenekler": [
            "what",
            "who",
            "when",
            "which",
            "why"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "Animals can also have reactions to pollen and other environmental allergens ---- they have different symptoms than we do and should be treated differently as well.",
        "secenekler": [
            "when",
            "though",
            "since",
            "so",
            "just as"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "People’s concepts of Western medicine ---- over the past several years, and they ---- much more of their healthcare providers.",
        "secenekler": [
            "have shifted / are demanding",
            "have been shifted / had demanded",
            "had shifted / were going to demand",
            "shifted / demanded",
            "were shifted / will demand"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "Reward Deficiency Syndrome is related to a number of mental health disorders ---- standing alone as a separate and distinct mental illness.",
        "secenekler": [
            "rather than",
            "along with",
            "in terms of",
            "with regard to",
            "due to"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "The essential oil ---- from the lavender flower is used in aromatherapy ---- anxiety, insomnia, nervousness, and restlessness.",
        "secenekler": [
            "deriving / to have treated",
            "derived / to treat",
            "to have derived / treated",
            "to be derived / treat",
            "to be deriving / treating"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "---- it is known that ionising radiation can cause brain tumours, most people are not exposed to this type of radiation unless they are being treated for cancer.",
        "secenekler": [
            "While",
            "Before",
            "So long as",
            "Until",
            "As though"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "Cataracts were once a leading cause of age-related blindness, but today ophthalmologists surgically ---- cataracts and replace the lens with a prosthetic intraocular one.",
        "secenekler": [
            "removed",
            "are removed",
            "have been removed",
            "remove",
            "are being removed"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "Joints are the structures where two or more bones come together, ---- directly ---- by means of strong fibrous cords called ligaments.",
        "secenekler": [
            "as / as",
            "either / or",
            "no sooner / than",
            "so / that",
            "the more / the more"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "Findings of a recent study ---- that green tea and carrots ---- a part in fighting Alzheimer's disease, though there is need for more research.",
        "secenekler": [
            "had suggested / would play",
            "have suggested / should have played",
            "suggest / could play",
            "suggested / used to play",
            "are suggesting / will have played"
        ],
        "dogruCevap": "C"
    },
    {
        "metin": "Many people use aspirin to relieve various kinds of minor aches and pains ---- headaches, toothaches, and muscle pain.",
        "secenekler": [
            "regardless of",
            "in the absence of",
            "by means of",
            "such as",
            "in contrast with"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "Eating chocolate at least once a week could help to reduce the risk of heart disease by as much as 8 percent ---- the nutrients in the chocolate, such as flavonoids, reducing inflammation and increasing good cholesterol.",
        "secenekler": [
            "prior to",
            "other than",
            "similar to",
            "thanks to",
            "in spite of"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "A daily low dose of aspirin is often recommended for people who are at risk of having a heart attack or stroke ---- it makes it easier for blood to flow through arteries.",
        "secenekler": [
            "unless",
            "whether",
            "as",
            "even if",
            "while"
        ],
        "dogruCevap": "C"
    },
    {
        "metin": "To soothe eczema flare-ups or inflamed skin, dermatologists advise rubbing on a cream ---- contains ceramides or colloidal oatmeal after every handwashing.",
        "secenekler": [
            "when",
            "that",
            "where",
            "whose",
            "in which"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "A mental health professional can diagnose a patient’s phobias ---- a detailed interview and discussion of both the mental and physical symptoms.",
        "secenekler": [
            "soon",
            "until",
            "for",
            "since",
            "after"
        ],
        "dogruCevap": "E"
    },
    {
        "metin": "People with eye issues such as bacterial infections no longer need to deal with eye drops or injections; ----, they can use smart contact lenses which can release medications over days or weeks.",
        "secenekler": [
            "conversely",
            "instead",
            "otherwise",
            "similarly",
            "even so"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "In order to increase bone density, the doctor may prescribe a number of medications ---- lifestyle measures such as healthy diet and exercise.",
        "secenekler": [
            "unlike",
            "so that",
            "as well as",
            "for example",
            "because of"
        ],
        "dogruCevap": "C"
    },
    {
        "metin": "Mothers of breastfeeding infants should report any medications they are taking ---- these can pass from mother to child in breast milk.",
        "secenekler": [
            "so that",
            "although",
            "since",
            "until",
            "if"
        ],
        "dogruCevap": "C"
    },
    {
        "metin": "---- a parent is advised so by the child’s physician, topical antibiotics should not be used on children under two months of age.",
        "secenekler": [
            "Since",
            "Unless",
            "Whereas",
            "As though",
            "In order that"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "Many childbirth experts believe that ---- a mother knows about the birth process ---- fear and apprehension she will feel giving birth.",
        "secenekler": [
            "whether / or",
            "the more / the more",
            "either / or",
            "not only / but also",
            "such / that"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "---- soy is high in protein, it helps boost the protein content of many food stuffs.",
        "secenekler": [
            "Although",
            "Until",
            "Whenever",
            "Because",
            "Unless"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "When medical professionals are treating dog bites, some wounds are left open and allowed to heal on their own, ---- others require stitches.",
        "secenekler": [
            "while",
            "before",
            "likewise",
            "since",
            "instead"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "People suffering from skin disorders ---- skin traction because the application of traction ---- their condition.",
        "secenekler": [
            "must not undergo / has aggravated",
            "cannot undergo / aggravated",
            "do not have to undergo / had aggravated",
            "may not undergo / has been aggravating",
            "should not undergo / will aggravate"
        ],
        "dogruCevap": "E"
    },
    {
        "metin": "Radiography, tomography, and magnetic resonance imaging are ---- important ---- their inventors received the Nobel Prize for their contributions to medicine.",
        "secenekler": [
            "as / well",
            "more / than",
            "the most / of",
            "so / that",
            "the less / the more"
        ],
        "dogruCevap": "D"
    },
    {
        "metin": "Technology, in the service of medicine, has permitted the understanding and prevention of many serious diseases ---- the study of early diagnostic techniques, such as magnetic resonance imaging and positron emission tomography.",
        "secenekler": [
            "unlike",
            "despite",
            "thanks to",
            "as regards",
            "as to"
        ],
        "dogruCevap": "C"
    },
    {
        "metin": "While dentistry ---- a quiet revolution with the emergence of holistic dentists, their complementary methods ---- under criticism.",
        "secenekler": [
            "has been undergoing / remain",
            "undergoes / would remain",
            "is undergoing / had remained",
            "had undergone / would have remained",
            "was undergoing / have remained"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "---- the belief that avocados should be omitted from calorie-controlled diets, a 2013 study by nutrition scientists found that they can play a useful role.",
        "secenekler": [
            "Owing to",
            "Contrary to",
            "In terms of",
            "Similar to",
            "By means of"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "Concussion, a jarring of the brain, usually leaves no lasting neurological problems; ----, symptoms of post-concussion syndrome may last for a long time.",
        "secenekler": [
            "in other words",
            "nonetheless",
            "therefore",
            "consequently",
            "for instance"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "Lactose intolerance does not affect an individual’s general health ---- the person gets necessary nutrients through alternative foods.",
        "secenekler": [
            "as long as",
            "in case",
            "unless",
            "as well as",
            "although"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "UV rays are quite damaging to our health, so experts recommend outdoor activities earlier in the morning or during the afternoon ---- the exposure is lower.",
        "secenekler": [
            "what",
            "when",
            "where",
            "which",
            "why"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "Most people realise how dependent on coffee and caffeine they have become ---- they try to give it up.",
        "secenekler": [
            "unless",
            "only when",
            "as if",
            "whether",
            "until"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "The human body is the most well-researched area in science; ----, experts have only just discovered how its powers of self-healing work.",
        "secenekler": [
            "however",
            "in addition",
            "in brief",
            "in other words",
            "likewise"
        ],
        "dogruCevap": "A"
    },
    {
        "metin": "Exercise is recommended by many therapists and physicians ---- it can provide relief and improve mobility.",
        "secenekler": [
            "although",
            "because",
            "even if",
            "unless",
            "until"
        ],
        "dogruCevap": "B"
    },
    {
        "metin": "---- the intricate structure and the overriding importance of the hand, any hand infection must be treated promptly and competently.",
        "secenekler": [
            "Along with",
            "Due to",
            "Regardless of",
            "In comparison with",
            "Instead of"
        ],
        "dogruCevap": "B"
    },
 ];
        
        const ui = { 
            sinavArayuzu: document.getElementById('sinav-arayuzu'), 
            sonucArayuzu: document.getElementById('sonuc-arayuzu'), 
            soruIcerik: document.getElementById('soru-icerik'), 
            optikFormIcerik: document.getElementById('optik-form-icerik'), 
            sinavPdfIndirBtn: document.getElementById('sinav-pdf-indir-btn'),
            onayPopup: document.getElementById('onay-popup'),
            bilgiPopup: document.getElementById('bilgi-popup'),
            sayacPopup: document.getElementById('sayac-popup'),
            soruDetayPopup: document.getElementById('soru-detay-popup')
        };

        const SINAVDAKI_SORU_SAYISI = SORU_HAVUZU.length; 
        const SORU_BASINA_DAKIKA = 1.5;
        const SINAV_SURESI_DAKIKA = Math.ceil(SINAVDAKI_SORU_SAYISI * SORU_BASINA_DAKIKA);
        let state = {};
        let unsubscribeOnSnapshot = null;

        function resetState() { 
            state = { 
                currentUser: state.currentUser,
                mevcutSoruIndex: 0, 
                sorular: [], 
                ogrenciCevaplari: {}, 
                ustuCiziliSecenekler: {}, 
                sinavAktif: false, 
                isReviewMode: false, 
                mainTimerInterval: null, 
                sonSonuc: null 
            }; 
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userData = await kullaniciVerisiCek(user.uid);
                state.currentUser = { ...user, ...userData };
                
                kullaniciBilgileriniYukle();
                olayDinleyicileriEkle();
                canliOturumDinleyicisiEkle();

                const reviewDataString = sessionStorage.getItem('reviewData');
                if (reviewDataString) {
                    const reviewData = JSON.parse(reviewDataString);
                    sinaviIncelemeModundaBaslat(reviewData);
                    sessionStorage.removeItem('reviewData');
                } else {
                    if (sessionStorage.getItem('sinavAktif')) {
                        sessionStorage.removeItem('sinavAktif');
                        document.body.innerHTML = `<div class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                            <h1 class="text-2xl font-bold text-red-600">Sınav esnasında sayfa yenilemek kural dışıdır. Oturumunuz sonlandırıldı.</h1>
                            <a href='./index.html' class="mt-4 bg-sky-500 text-white font-bold py-2 px-4 rounded-lg">Ana Sayfaya Dön</a>
                        </div>`;
                        return;
                    }
                    sinaviBaslat();
                }
            } else {
                window.location.href = './index.html';
            }
        });

        async function kullaniciVerisiCek(uid) {
            const userDocRef = doc(db, "kullanicilar", uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.warn("Kullanıcı veri dokümanı bulunamadı.");
                    return { isim: null, soyisim: null };
                }
            } catch (error) {
                console.error("Kullanıcı verisi çekilirken hata:", error);
                return { isim: null, soyisim: null };
            }
        }

        function kullaniciBilgileriniYukle() {
            if(state.currentUser) {
                const { isim, soyisim, email } = state.currentUser;
                const gorunecekIsim = (isim && soyisim) ? `${isim} ${soyisim}` : (email);
                document.querySelector('.kullanici-ad-soyad').textContent = gorunecekIsim;
            }
        }

        function olayDinleyicileriEkle() {
            document.getElementById('sinav-sonlandir-btn').addEventListener('click', () => { showOnayPopup('Sınavı sonlandırmak istediğinize emin misiniz? Cevaplarınız kaydedilecek.', () => sinaviSonlandir(true), 'Evet, Sonlandır'); });
            document.getElementById('prev-btn').addEventListener('click', oncekiSoru);
            document.getElementById('next-btn').addEventListener('click', sonrakiSoru);
            document.getElementById('sorulari-incele-btn').addEventListener('click', () => { if (state.sonSonuc) { sessionStorage.setItem('reviewData', JSON.stringify(state.sonSonuc)); window.location.reload(); } });
            document.getElementById('gecmis-sayfasina-git-btn').addEventListener('click', () => { window.location.href = './gecmis-sinavlar.html'; });
            document.getElementById('yeni-sinav-btn').addEventListener('click', () => { window.location.href = './index.html'; });
            
            ui.soruIcerik.addEventListener('click', (event) => {
                if (state.isReviewMode) return;
                const listItem = event.target.closest('li[data-option]');
                if (listItem) {
                    const soruId = state.sorular[state.mevcutSoruIndex].id;
                    const secenek = listItem.dataset.option;
                    selectAnswer(soruId, secenek);
                }
            });

            document.getElementById('optik-form-icerik').addEventListener('change', (event) => {
                 if (event.target.type === 'radio' && !state.isReviewMode) {
                    const soruId = parseInt(event.target.dataset.soruId);
                    const secenek = event.target.value;
                    selectAnswer(soruId, secenek);
                 }
            });

            ui.soruIcerik.addEventListener('contextmenu', handleStrikethrough);
            document.getElementById('optik-form-sonuc').addEventListener('click', (event) => { const satir = event.target.closest('[data-soru-id]'); if (satir && satir.dataset.soruId) { showSoruDetayPopup(parseInt(satir.dataset.soruId)); } });
            document.getElementById('sonuclara-don-btn').addEventListener('click', () => { if (state.sonSonuc) { showSonucSayfasi(state.sonSonuc); } });
            
            ui.soruIcerik.addEventListener('mouseup', (event) => {
                if (!event.target.closest('.question-text')) return;
                const selection = window.getSelection();
                if (selection.isCollapsed || selection.rangeCount === 0) return;
                const range = selection.getRangeAt(0);
                if (range.commonAncestorContainer.parentNode.closest('.question-text')) {
                    const mark = document.createElement('mark');
                    try { range.surroundContents(mark); } 
                    catch (e) { console.warn("Seçim tam olarak sarılamadı.", e); }
                }
                selection.removeAllRanges();
            });

            ui.soruIcerik.addEventListener('click', (event) => {
                if (event.target.tagName === 'MARK' && event.target.closest('.question-text')) {
                    const markElement = event.target;
                    const parent = markElement.parentNode;
                    markElement.replaceWith(document.createTextNode(markElement.textContent));
                    parent.normalize();
                }
            });

            ui.sinavPdfIndirBtn.addEventListener('click', () => sorulariPDFIndir(false));
            document.getElementById('sonuc-pdf-indir-btn').addEventListener('click', () => sorulariPDFIndir(true));
            
            document.getElementById('onay-iptal-btn').addEventListener('click', () => hideModal(ui.onayPopup));
            document.getElementById('bilgi-kapat-btn').addEventListener('click', () => hideModal(ui.bilgiPopup));
            document.getElementById('soru-detay-kapat-btn').addEventListener('click', () => hideModal(ui.soruDetayPopup));

        }
        
        async function canliOturumDinleyicisiEkle() {
            window.addEventListener('beforeunload', async () => {
                if (state.sinavAktif && state.currentUser) {
                    const sessionRef = doc(db, 'aktifOturumlar', state.currentUser.uid);
                    await deleteDoc(sessionRef);
                }
            });
        }
        
        async function sinaviSonlandir(kullaniciIstegi) {
            state.sinavAktif = false;
            if (unsubscribeOnSnapshot) unsubscribeOnSnapshot();

            if (state.currentUser) {
                const sessionRef = doc(db, 'aktifOturumlar', state.currentUser.uid);
                await deleteDoc(sessionRef).catch(err => console.error("Canlı oturum silinemedi:", err));
            }

            sessionStorage.removeItem('sinavAktif');
            clearInterval(state.mainTimerInterval);
            document.querySelectorAll('#sinav-arayuzu button, #sinav-arayuzu input').forEach(el => el.disabled = true);
            
            const sonuc = sonuclariHesapla();
            state.sonSonuc = sonuc.local;
            
            await sonucuSunucuyaGonder(sonuc.firebase);
            sonucuLocaleKaydet(sonuc.local);
            
            let mesaj = kullaniciIstegi ? "Sınavınız sonlandırılmıştır.<br>Sonuçlarınız başarıyla kaydedildi." : "Süreniz dolduğu için sınavınız sonlandırılmıştır.<br>Sonuçlarınız başarıyla kaydedildi.";
            showBilgiPopup(mesaj, () => startResultsCountdown(sonuc.local));
        }
        
        async function sinaviBaslat() {
            if (state.sinavAktif) return;
            resetState();
            
            if (!sorulariYukle()) return;

            ui.sonucArayuzu.classList.add('hidden');
            ui.sinavArayuzu.classList.remove('hidden');
            state.sinavAktif = true;

            if (state.currentUser) {
                const { isim, soyisim } = state.currentUser;
                const sessionRef = doc(db, "aktifOturumlar", state.currentUser.uid);
                
                await setDoc(sessionRef, {
                    isim: isim || 'Bilinmiyor',
                    soyisim: soyisim || '',
                    sinavTuru: "Çıkmış Sorular",
                    baslamaZamani: serverTimestamp()
                }).catch(err => console.error("Canlı oturum başlatılamadı:", err));

                unsubscribeOnSnapshot = onSnapshot(sessionRef, (doc) => {
                    if (!doc.exists() && state.sinavAktif) sinaviAdminSonlandirdi();
                });
            }

            sessionStorage.setItem('sinavAktif', 'true');
            optikFormuCiz();
            soruyuEkranaCiz(state.mevcutSoruIndex);
            startMainExamTimer();
        }

        async function sonucuSunucuyaGonder(sonuc) {
            if (!state.currentUser) return console.error("Kullanıcı girişi yapılmadığı için sonuç kaydedilemedi.");
            try {
                const userExamsCollectionRef = collection(db, "kullanicilar", state.currentUser.uid, "sinavlar");
                await addDoc(userExamsCollectionRef, sonuc);
                console.log("Sonuç başarıyla Firebase'e kaydedildi.");
            } catch (e) {
                console.error("Firebase'e yazılırken hata oluştu: ", e);
            }
        }
        
        function sonucuLocaleKaydet(sonuc) {
            if (!state.currentUser) return;
            let sinavGecmisi = JSON.parse(localStorage.getItem(`sinavGecmisi_${state.currentUser.uid}`)) || [];
            sinavGecmisi.push(sonuc);
            localStorage.setItem(`sinavGecmisi_${state.currentUser.uid}`, JSON.stringify(sinavGecmisi));
        }

        function sinaviAdminSonlandirdi() {
            if (!state.sinavAktif) return;
            if (unsubscribeOnSnapshot) unsubscribeOnSnapshot();
            clearInterval(state.mainTimerInterval);
            state.sinavAktif = false;
            document.querySelectorAll('#sinav-arayuzu button, #sinav-arayuzu input').forEach(el => el.disabled = true);
            showBilgiPopup('Oturumunuz yönetici tarafından sonlandırılmıştır. Ana sayfaya yönlendiriliyorsunuz.', () => {
                window.location.href = './index.html';
            });
        }

        function soruyuEkranaCiz(index) {
            const soru = state.sorular[index];
            const ustucizililer = state.ustuCiziliSecenekler[soru.id] || [];
            
            let seceneklerHtml = soru.secenekler.map((secenek, i) => {
                const secenekHarfi = String.fromCharCode(65 + i);
                const isChecked = state.ogrenciCevaplari[soru.id] === secenekHarfi;
                const isStriked = ustucizililer.includes(secenekHarfi);
                
                const liClasses = `flex items-start gap-4 p-4 rounded-lg border-2 cursor-pointer transition-all duration-200 transform hover:scale-[1.02] ${isChecked ? 'bg-sky-50 border-sky-500 scale-[1.02] shadow-md' : 'bg-white border-slate-200 hover:border-sky-300'}`;
                const labelClasses = `flex items-center justify-center w-8 h-8 rounded-full border-2 flex-shrink-0 mt-1 transition ${isChecked ? 'bg-sky-500 border-sky-500 text-white' : 'bg-white border-slate-300'}`;
                const spanClasses = `flex-grow pt-1 ${isStriked ? 'line-through text-slate-400' : 'text-slate-700'}`;

                return `<li class="${liClasses}" data-option="${secenekHarfi}">
                            <label for="secenek-${soru.id}-${secenekHarfi}" class="${labelClasses} no-select">${secenekHarfi}</label>
                            <span class="${spanClasses}">${secenek}</span>
                        </li>`;
            }).join('');

            ui.soruIcerik.innerHTML = `
                <div class="mb-4">
                    <p class="text-xl font-bold text-slate-800">Soru ${soru.id} / ${state.sorular.length}</p>
                </div>
                <div class="bg-sky-50 text-sky-800 p-4 rounded-lg mb-6 border-l-4 border-sky-400">
                    ${soru.talimat || "For these questions, choose the best word or expression to fill the space."}
                </div>
                <div class="question-text text-xl text-slate-800 leading-relaxed mb-8">${soru.metin}</div>
                <ul class="space-y-3">${seceneklerHtml}</ul>`;

            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === state.sorular.length - 1;
        }

        function optikFormuCiz() {
            ui.optikFormIcerik.innerHTML = state.sorular.map(soru => {
                const seceneklerHtml = ['A', 'B', 'C', 'D', 'E'].map(secenek => {
                    const isChecked = state.ogrenciCevaplari[soru.id] === secenek;
                    return `<div>
                                <input type="radio" id="optik-${soru.id}-${secenek}" name="optik-soru-${soru.id}" value="${secenek}" ${isChecked ? "checked" : ""} class="hidden peer">
                                <label for="optik-${soru.id}-${secenek}" class="w-8 h-8 flex items-center justify-center rounded-full border border-slate-300 cursor-pointer transition peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 hover:border-slate-500">${secenek}</label>
                            </div>`;
                }).join('');

                return `<div class="grid grid-cols-[auto,1fr] items-center gap-3 p-2 rounded-md hover:bg-slate-50" id="optik-soru-${soru.id}">
                            <span class="font-bold text-slate-600">${soru.id}</span>
                            <div class="flex justify-around">${seceneklerHtml}</div>
                        </div>`;
            }).join('');
        }
        
        function selectAnswer(soruId, secenek) {
            if (state.isReviewMode) return;
            
            // Cevabı state'e kaydet
            state.ogrenciCevaplari[soruId] = secenek;

            // Sadece mevcut soru ekrandaysa soru panelini güncelle
            if (state.sorular[state.mevcutSoruIndex].id === soruId) {
                soruyuEkranaCiz(state.mevcutSoruIndex);
            }

            // Optik formu her zaman güncelle
            const optikRadios = document.querySelectorAll(`input[name="optik-soru-${soruId}"]`);
            optikRadios.forEach(radio => radio.checked = (radio.value === secenek));
        }

        function sorulariYukle() {
            if (SORU_HAVUZU.length === 0) {
                alert("Sınav başlatılamıyor: Soru havuzu boş!");
                document.body.innerHTML = `<div class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                    <h1 class="text-2xl font-bold text-red-600">Soru havuzunda hiç soru bulunamadı.</h1>
                    <a href='./index.html' class="mt-4 bg-sky-500 text-white font-bold py-2 px-4 rounded-lg">Ana Sayfaya Dön</a>
                </div>`;
                return false;
            }
            const secilecekSoruSayisi = Math.min(SINAVDAKI_SORU_SAYISI, SORU_HAVUZU.length);
            const secilenSorular = [...SORU_HAVUZU].sort(() => 0.5 - Math.random()).slice(0, secilecekSoruSayisi);
            
            state.sorular = secilenSorular.map((soru, index) => ({ 
                id: index + 1, 
                talimat: soru.talimat || "For these questions, choose the best word or expression to fill the space.", 
                ...soru 
            }));
            return true;
        }

        function sonuclariHesapla() {
            let dogru = 0, yanlis = 0, bos = 0;
            const { isim, soyisim, email } = state.currentUser;
            const kullaniciAdi = (isim && soyisim) ? `${isim} ${soyisim}` : email;
            
            state.sorular.forEach(soru => {
                const ogrenciCevabi = state.ogrenciCevaplari[soru.id];
                if (!ogrenciCevabi) bos++;
                else if (ogrenciCevabi === soru.dogruCevap) dogru++;
                else yanlis++;
            });

            const net = (dogru - (yanlis / 4)).toFixed(2);
            
            const sonucData = {
                isim: kullaniciAdi, 
                sinavTuru: "Çıkmış Sorular", 
                dogruSayisi: dogru, 
                yanlisSayisi: yanlis, 
                bosSayisi: bos,
                netSayisi: net, 
                toplamSoru: state.sorular.length, 
                sorular: state.sorular, 
                ogrenciCevaplari: state.ogrenciCevaplari
            };
            
            return {
                firebase: { ...sonucData, tarih: serverTimestamp() },
                local: { ...sonucData, tarih: new Date().toLocaleString('tr-TR') }
            };
        }
        
        function handleStrikethrough(event) { 
            if (state.isReviewMode) return; 
            const listItem = event.target.closest('li'); 
            if (listItem) { 
                event.preventDefault(); 
                const soruId = state.sorular[state.mevcutSoruIndex].id; 
                const secenek = listItem.dataset.option; 
                if (!state.ustuCiziliSecenekler[soruId]) state.ustuCiziliSecenekler[soruId] = []; 
                const index = state.ustuCiziliSecenekler[soruId].indexOf(secenek); 
                if (index > -1) state.ustuCiziliSecenekler[soruId].splice(index, 1); 
                else state.ustuCiziliSecenekler[soruId].push(secenek); 
                listItem.querySelector('span').classList.toggle('line-through'); 
                listItem.querySelector('span').classList.toggle('text-slate-400'); 
            } 
        }

        function oncekiSoru() { if (state.mevcutSoruIndex > 0) { state.mevcutSoruIndex--; soruyuEkranaCiz(state.mevcutSoruIndex); } }
        function sonrakiSoru() { if (state.mevcutSoruIndex < state.sorular.length - 1) { state.mevcutSoruIndex++; soruyuEkranaCiz(state.mevcutSoruIndex); } }
        function startMainExamTimer() { const timerEl = document.getElementById('main-exam-timer'); let saniye = SINAV_SURESI_DAKIKA * 60; state.mainTimerInterval = setInterval(() => { if (saniye < 0) { clearInterval(state.mainTimerInterval); sinaviSonlandir(false); return; } const saat = Math.floor(saniye / 3600); const dakika = Math.floor((saniye % 3600) / 60); const kalanSaniye = saniye % 60; timerEl.textContent = [saat, dakika, kalanSaniye].map(v => v < 10 ? '0' + v : v).join(':'); saniye--; }, 1000); }
        
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModal(modalElement) {
             modalElement.querySelector('.transform').classList.add('scale-95', 'opacity-0');
             setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 200);
        }

        function showBilgiPopup(mesaj, callback) { 
            const popup = ui.bilgiPopup; 
            popup.querySelector('#bilgi-mesaji').innerHTML = mesaj; 
            showModal(popup);
            const kapatBtn = popup.querySelector('#bilgi-kapat-btn'); 
            const handler = () => { 
                hideModal(popup); 
                if(callback) callback(); 
            }; 
            kapatBtn.addEventListener('click', handler, {once: true}); 
        }

        function showOnayPopup(mesaj, callback, confirmText = 'Evet') { 
            const popup = ui.onayPopup; 
            popup.querySelector('#onay-mesaji').innerHTML = mesaj; 
            const devamBtn = popup.querySelector('#onay-devam-btn'); 
            devamBtn.textContent = confirmText; 
            showModal(popup);
            const iptalBtn = popup.querySelector('#onay-iptal-btn'); 
            const devamListener = () => { hideModal(popup); callback(); }; 
            const iptalListener = () => { hideModal(popup); }; 
            devamBtn.addEventListener('click', devamListener, { once: true }); 
            iptalBtn.addEventListener('click', iptalListener, { once: true }); 
        }

        function startResultsCountdown(sonuc) { 
            const popup = ui.sayacPopup; 
            showModal(popup);
            let sayac = 5; 
            const sayacElementi = document.getElementById('gerisayim-sayaci'); 
            sayacElementi.textContent = sayac; 
            const interval = setInterval(() => { 
                sayac--; 
                sayacElementi.textContent = sayac; 
                if (sayac <= 0) { 
                    clearInterval(interval); 
                    hideModal(popup);
                    showSonucSayfasi(sonuc); 
                } 
            }, 1000); 
        }

        function showSonucSayfasi(sonuc) {
            ui.sinavArayuzu.classList.add('hidden');
            ui.sonucArayuzu.classList.remove('hidden');

            const { isim, soyisim, email } = state.currentUser;
            const fullName = (isim && soyisim) ? `${isim.toUpperCase()} ${soyisim.toUpperCase()}` : email.toUpperCase();
            document.getElementById('sonuc-kullanici-ad-soyad').textContent = fullName;
            
            document.getElementById('dogru-sayisi').textContent = sonuc.dogruSayisi;
            document.getElementById('yanlis-sayisi').textContent = sonuc.yanlisSayisi;
            document.getElementById('bos-sayisi').textContent = sonuc.bosSayisi;
            document.getElementById('net-sayisi-buyuk').textContent = sonuc.netSayisi;
            
            sonucOptikFormuCiz(sonuc);
        }

        function sinaviIncelemeModundaBaslat(reviewData) { 
            resetState(); 
            state.isReviewMode = true; 
            state.sonSonuc = reviewData; 
            state.sorular = reviewData.sorular; 
            state.ogrenciCevaplari = reviewData.ogrenciCevaplari; 
            ui.sonucArayuzu.classList.add('hidden'); 
            ui.sinavArayuzu.classList.remove('hidden'); 
            document.getElementById('main-exam-timer').textContent = "İNCELEME"; 
            document.getElementById('sinav-sonlandir-btn').classList.add('hidden'); 
            document.getElementById('sonuclara-don-btn').classList.remove('hidden'); 
            ui.sinavPdfIndirBtn.disabled = false; 
            optikFormuCiz(); 
            soruyuEkranaCiz(state.mevcutSoruIndex); 
            cevaplariGoster(); 
        }

        function cevaplariGoster() { 
            state.sorular.forEach(soru => { 
                const ogrenciCevabi = state.ogrenciCevaplari[soru.id]; 
                const dogruCevap = soru.dogruCevap; 
                const dogruLabel = document.querySelector(`#optik-soru-${soru.id} label[for='optik-${soru.id}-${dogruCevap}']`); 
                if (dogruLabel) dogruLabel.classList.add('!bg-green-500', '!border-green-500', '!text-white'); 
                if (ogrenciCevabi && ogrenciCevabi !== dogruCevap) { 
                    const yanlisLabel = document.querySelector(`#optik-soru-${soru.id} label[for='optik-${soru.id}-${ogrenciCevabi}']`); 
                    if (yanlisLabel) yanlisLabel.classList.add('!bg-red-500', '!border-red-500', '!text-white'); 
                } 
            }); 
        }

        function sonucOptikFormuCiz(sonuc) { 
            const container = document.getElementById('optik-form-sonuc'); 
            container.innerHTML = sonuc.sorular.map(soru => { 
                const ogrenciCevabi = sonuc.ogrenciCevaplari[soru.id]; 
                const dogruCevap = soru.dogruCevap; 
                let durumText = '', durumClass = ''; 
                if (!ogrenciCevabi) { 
                    durumText = 'BOŞ'; 
                    durumClass = 'bg-slate-500'; 
                } else if (ogrenciCevabi === dogruCevap) { 
                    durumText = 'DOĞRU'; 
                    durumClass = 'bg-green-500'; 
                } else { 
                    durumText = 'YANLIŞ'; 
                    durumClass = 'bg-red-500'; 
                } 
                return `<div class="p-3 bg-slate-50 rounded-lg flex items-center gap-4 cursor-pointer hover:bg-slate-100 transition-colors" data-soru-id="${soru.id}">
                        <div class="font-bold text-slate-700 w-16">${soru.id}. Soru</div>
                        <div class="flex-grow flex justify-start gap-2">
                            ${['A', 'B', 'C', 'D', 'E'].map(secenek => {
                                let siniflar = 'w-9 h-9 flex items-center justify-center rounded-full font-semibold border-2 relative';
                                if (secenek === dogruCevap) {
                                    siniflar += ' bg-green-100 border-green-500 text-green-700';
                                } else if (secenek === ogrenciCevabi) {
                                    siniflar += ' bg-red-100 border-red-500 text-red-700';
                                } else {
                                    siniflar += ' bg-white border-slate-200 text-slate-600';
                                }
                                if(secenek === ogrenciCevabi && ogrenciCevabi === dogruCevap){
                                     siniflar += ' ring-2 ring-offset-2 ring-sky-500';
                                }
                                return `<div class="${siniflar}">${secenek}</div>`;
                            }).join('')}
                        </div>
                        <div class="text-white text-xs font-bold px-3 py-1 rounded-full ${durumClass}">${durumText}</div>
                    </div>`; 
            }).join(''); 
        }

        function showSoruDetayPopup(soruId) { 
            const popup = ui.soruDetayPopup; 
            const soru = state.sonSonuc.sorular.find(s => s.id === soruId); 
            const ogrenciCevabi = state.sonSonuc.ogrenciCevaplari[soruId]; 
            const dogruCevap = soru.dogruCevap; 
            document.getElementById('soru-detay-baslik').textContent = `Soru ${soru.id} Detayı`; 
            document.getElementById('soru-detay-metin').innerHTML = soru.metin; 
            const seceneklerContainer = document.getElementById('soru-detay-secenekler'); 
            seceneklerContainer.innerHTML = soru.secenekler.map((secenekMetni, index) => { 
                const secenekHarfi = String.fromCharCode(65 + index); 
                let rowClass = 'flex justify-between items-center p-4 rounded-lg border-2'; 
                let iconHtml = '<span></span>'; 
                const isCorrect = (secenekHarfi === dogruCevap); 
                const isStudentAnswer = (secenekHarfi === ogrenciCevabi); 
                if (isCorrect) { 
                    rowClass += ' bg-green-50 border-green-500'; 
                    iconHtml = '<span class="text-green-600 font-bold text-xl">✓</span>'; 
                } else if (isStudentAnswer && !isCorrect) { 
                    rowClass += ' bg-red-50 border-red-500'; 
                    iconHtml = '<span class="text-red-600 font-bold text-xl">✗</span>'; 
                } else { 
                    rowClass += ' border-slate-200';
                } 
                return `<li class="${rowClass}"><div><span class="font-bold text-slate-800 mr-2">${secenekHarfi})</span><span class="text-slate-700">${secenekMetni}</span></div>${iconHtml}</li>`; 
            }).join(''); 
            showModal(popup);
        }

        function sorulariPDFIndir(forceDownload = false) {
            const canDownload = state.sinavAktif || forceDownload || state.isReviewMode;
            if (!canDownload || !state.sorular || state.sorular.length === 0) {
                alert("Yazdırmak için geçerli bir sınav verisi bulunmalıdır.");
                return;
            }
            const { isim, soyisim, email } = state.currentUser;
            const ogrenciAdi = (isim && soyisim) ? `${isim} ${soyisim}` : email;
            const sinavBasligi = `Çıkmış Sorular Sınav Kitapçığı`;
            const tarih = new Date().toLocaleDateString('tr-TR');
            const printStyles = `<style>@page{size:A4;margin:20mm 15mm}body{font-family:'Carlito',Calibri,sans-serif;color:#333}.main-header{text-align:center;border-bottom:2px solid #333;padding-bottom:10px;margin-bottom:15px;page-break-after:avoid}.main-header h1{font-size:22px;margin:0 0 5px 0;color:#111;font-weight:700}.main-header p{font-size:12px;margin:0;color:#555}.content{column-count:2;column-gap:15mm;column-rule:1px solid #ccc}.question-block{page-break-inside:avoid;-webkit-column-break-inside:avoid;break-inside:avoid;margin-bottom:14px}.question-title{font-size:11.5px;font-weight:700;color:#000;line-height:1.5;margin-bottom:8px}.options-list{padding-left:5px;font-size:11px;line-height:1.5}.option-item{margin-bottom:5px}.option-item strong{font-weight:700}.page-footer{position:fixed;bottom:10mm;left:15mm;right:15mm;text-align:center;font-size:10px;color:#888}.page-number::after{content:counter(page)}</style>`;
            let headerHTML = `<div class="main-header"><h1>${sinavBasligi}</h1><p>Öğrenci: ${ogrenciAdi} &nbsp;&nbsp;|&nbsp;&nbsp; Tarih: ${tarih}</p></div>`;
            let contentHTML = '<div class="content">';
            state.sorular.forEach((soru, index) => {
                const soruMetni = soru.metin.replace(/<[^>]*>?/gm, '');
                contentHTML += `<div class="question-block"><div class="question-title">${index + 1}. ${soruMetni}</div><div class="options-list">`;
                soru.secenekler.forEach((secenek, i) => {
                    const harf = String.fromCharCode(65 + i);
                    const secenekMetni = secenek.replace(/<[^>]*>?/gm, '');
                    contentHTML += `<div class="option-item"><strong>${harf})</strong> ${secenekMetni}</div>`;
                });
                contentHTML += `</div></div>`;
            });
            contentHTML += `</div>`;
            let footerHTML = `<div class="page-footer"><span class="page-number"></span></div>`;
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write(`<html><head><title>${sinavBasligi} - ${ogrenciAdi}</title>${printStyles}</head><body>${headerHTML}${contentHTML}${footerHTML}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
        }
    </script>
</body>
</html>





